<?php session_start(); ?>
<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="/css/materialize.min.css" rel="stylesheet" />
</head>

<body>
	
    <div class="container">
        <div class="row">
            <div class="col offset-s5 s2">Done <?php echo $_SESSION['user'];?></div>
        </div>
    </div>
	<div class='row card-panel'>
<div class='col s5 offset-s1'>Remaining<b id='rem'></b></div><div class='col s5 offset-s1'>Filled<b id='f'></b></div></div>
    <div class="row">
        <!--div class="card-panel center col s6 offset-s3" style="background:skyblue;color:white;height:40px"> <b>Water is available</b></!--div-->
        <span>
            <button id="str" class="col btn offset-s4 s2" onclick="start()" style="color:white">Start</button>
            <button id="fin" class="col btn s2 red" disabled onclick="finish()">Finish</button>
        </span>
     </div>
    <script>
	var perm = '<?php  echo $_SESSION["perm"]; ?>';
	if(perm == ''){
		alert('First complete payment');
		window.location.assign('./payment.php');
	}
        var x,y,state = 0, tem = 3;//state = 0 - start , 1 - middle , 2 - finish
        if(window.XMLHttpRequest){
            x = new XMLHttpRequest();
        }else{
            x = new ActiveXObject("Microsoft.XMLHTTP");
        }
        x.onreadystatechange = function(){
                //alert(x.readyState);
                    if(x.readyState == 4 && x.status == 200){
                        var res = JSON.parse(x.responseText);
                        //alert(res.value); 
                        //alert(x.responseText);
                        if(res.ok === 1 && tem > 0){
                            //alert(res.rem);
				document.getElementById('rem').innerHTML = res.rem;
                            tem = tem - 1;
                        }//else if(res.rem < 0){}
			else {
				clearInterval(y);
			//finish();
			}
                        
                    }
                };
        
        function start(){
	    state = 0;
            document.getElementById('str').disabled = true;
            document.getElementById('fin').disabled = false;            
            y = setInterval(get,1000);
        }
        function get(){
	if(state == 0){
            x.open("GET",'./get.php?state=0',true);
            x.send();
        }
	}
        function finish(){
	state = 2;
            x.open("GET",'./get.php?state=2',true);
            x.send();
            clearInterval(y);
	    document.getElementById('fin').disable = false;
	    document.getElementById('str').disable = true;
            alert("Finished");
	window.location.assign('./payment.php');
        }
    </script>
</body>
</html>
